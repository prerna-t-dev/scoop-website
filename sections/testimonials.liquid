{%- render 'section-spacing-collapsing' -%}

{%- comment -%}
------------------------------------------------------------------------------------------------------------------------
CSS
------------------------------------------------------------------------------------------------------------------------
{%- endcomment -%}
<style>
  #shopify-section-{{ section.id }} {
    --testimonials-background: {{ section.settings.background_color }};
    --section-spacing-inline: 0;
  }

  #shopify-section-{{ section.id }} .testimonials {
    background: var(--testimonials-background);
    padding: {{ section.settings.padding_mobile }}px 0;
  }

  #shopify-section-{{ section.id }} > div {
    padding-left: 0 !important;
    padding-right: 0 !important;
  }

  #shopify-section-{{ section.id }} .testimonials__header {
    text-align: center;
    margin-bottom: {{ section.settings.header_spacing_mobile }}px;
    padding: 0 var(--container-gutter);
  }

  #shopify-section-{{ section.id }} .testimonials__title {
    font-family: var(--heading-font-family);
    font-size: {{ section.settings.title_font_size_mobile }}px;
    font-weight: {{ section.settings.title_font_weight }};
    line-height: 1.2;
    color: {{ section.settings.title_color }};
    margin: 0;
    font-style: {{ section.settings.title_font_style }} !important;
  }

  #shopify-section-{{ section.id }} .testimonials__title em {
    font-style: italic;
  }

  #shopify-section-{{ section.id }} .testimonials__slider-wrapper {
    position: relative;
  }

  #shopify-section-{{ section.id }} .testimonials__slider {
    display: grid;
    grid-auto-flow: column;
    grid-auto-columns: calc((100vw - 60px) * 0.85);
    gap: var(--spacing-4);
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    scroll-padding-inline: calc((100vw - (100vw - 60px) * 0.85) / 2);
    padding-inline: calc((100vw - (100vw - 60px) * 0.85) / 2);
    scrollbar-width: none;
    -ms-overflow-style: none;
  }

  #shopify-section-{{ section.id }} .testimonials__slider::-webkit-scrollbar {
    display: none;
  }

  #shopify-section-{{ section.id }} .testimonial-card {
    scroll-snap-align: start;
    border-radius: {{ section.settings.card_border_radius }}px;
    padding: {{ section.settings.card_padding_mobile }}px;
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  {%- for block in section.blocks -%}
    #shopify-section-{{ section.id }} .testimonial-card[data-block-id="{{ block.id }}"] {
      background: {{ block.settings.card_background }};
    }
    #shopify-section-{{ section.id }} .testimonial-card[data-block-id="{{ block.id }}"] .testimonial-card__quote {
      color: {{ block.settings.heading_color }};
    }
    #shopify-section-{{ section.id }} .testimonial-card[data-block-id="{{ block.id }}"] .testimonial-card__heading {
      color: {{ block.settings.heading_color }};
    }
  {%- endfor -%}

  #shopify-section-{{ section.id }} .testimonial-card__quote {
    font-size: 30px;
    line-height: 1;
    margin: 0;
    font-family: var(--text-font-family) !important;
    font-style: italic;
  }

  #shopify-section-{{ section.id }} .testimonial-card__heading {
    font-size: {{ section.settings.heading_size_mobile }}px;
    font-weight: {{ section.settings.heading_weight }};
    margin: 0 0 12px 0;
    line-height: 1.3;
    font-family: var(--text-font-family) !important;
  }

  #shopify-section-{{ section.id }} .testimonial-card__text {
    font-size: {{ section.settings.text_size_mobile }}px;
    line-height: 1.6;
    color: {{ section.settings.text_color }};
    margin: 0;
    font-family: var(--text-font-family);
  }

  #shopify-section-{{ section.id }} .testimonial-card__text em {
    font-style: italic;
    font-family: var(--text-font-family);
  }

  #shopify-section-{{ section.id }} .testimonial-card__footer {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  #shopify-section-{{ section.id }} .testimonial-card__image {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    overflow: hidden;
    flex-shrink: 0;
  }

  #shopify-section-{{ section.id }} .testimonial-card__image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  #shopify-section-{{ section.id }} .testimonial-card__author {
    flex: 1;
  }

  #shopify-section-{{ section.id }} .testimonial-card__name {
    font-weight: 600;
    font-size: 16px;
    margin: 0 0 4px 0;
    color: {{ section.settings.author_color }};
  }

  #shopify-section-{{ section.id }} .testimonial-card__meta {
    font-size: 14px;
    color: {{ section.settings.meta_color }};
    margin: 0;
  }

  #shopify-section-{{ section.id }} .testimonial-card--clone {
    pointer-events: none;
  }

  /* Scallop button styling */
  #shopify-section-{{ section.id }} .circle-button.testimonials-scallop-button {
    background: transparent !important;
    border: none !important;
    padding: 0 !important;
    cursor: pointer;
    display: inline-flex !important;
    align-items: center;
    justify-content: center;
    box-shadow: none !important;
    width: 51px !important;
    height: 51px !important;
    min-width: 51px !important;
    min-height: 51px !important;
  }

  #shopify-section-{{ section.id }} .circle-button.testimonials-scallop-button svg {
    width: 51px !important;
    height: 51px !important;
    display: block;
    transition: transform 0.2s ease;
  }

  #shopify-section-{{ section.id }} .circle-button.testimonials-scallop-button:hover svg {
    transform: scale(1.1);
  }

  @media screen and (min-width: 700px) {
    #shopify-section-{{ section.id }} .testimonials {
      padding: {{ section.settings.padding_desktop }}px 0;
    }

    #shopify-section-{{ section.id }} .testimonials__header {
      margin-bottom: {{ section.settings.header_spacing_desktop }}px;
    }

    #shopify-section-{{ section.id }} .testimonials__title {
      font-size: {{ section.settings.title_font_size_desktop }}px;
    }

    #shopify-section-{{ section.id }} .testimonials__slider {
      grid-auto-columns: calc((100vw - 120px - (var(--spacing-5) * 2)) / 3);
      gap: var(--spacing-5);
      scroll-padding-inline: 60px;
      padding-inline: 60px;
    }

    #shopify-section-{{ section.id }} .testimonial-card {
      padding: {{ section.settings.card_padding_desktop }}px;
    }

    #shopify-section-{{ section.id }} .testimonial-card__quote {
      font-size: {{ section.settings.quote_size_desktop }}px;
    }

    #shopify-section-{{ section.id }} .testimonial-card__heading {
      font-size: {{ section.settings.heading_size_desktop }}px;
    }

    #shopify-section-{{ section.id }} .testimonial-card__text {
      font-size: {{ section.settings.text_size_desktop }}px;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const carousel = document.querySelector('#shopify-section-{{ section.id }} .testimonials__slider');
    if (!carousel) return;

    const totalBlocks = {{ section.blocks.size }};
    const cloneCount = Math.min(3, totalBlocks);
    
    if (totalBlocks <= 3) return; // No need for infinite scroll with 3 or fewer items

    let isScrolling = false;
    let scrollTimeout;

    function getItemOffset() {
      const items = carousel.querySelectorAll('.scroll-area__item:not(.testimonial-card--clone)');
      const itemWidth = items[0]?.offsetWidth || 0;
      const gap = parseFloat(getComputedStyle(carousel).gap) || 0;
      return itemWidth + gap;
    }

    function scrollToOriginalPosition() {
      const items = carousel.querySelectorAll('.scroll-area__item');
      const itemWidth = items[0]?.offsetWidth || 0;
      const gap = parseFloat(getComputedStyle(carousel).gap) || 0;
      carousel.scrollLeft = cloneCount * (itemWidth + gap);
    }

    carousel.addEventListener('scroll', function() {
      if (isScrolling) return;

      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(function() {
        const scrollLeft = carousel.scrollLeft;
        const scrollWidth = carousel.scrollWidth;
        const clientWidth = carousel.clientWidth;
        const itemOffset = getItemOffset();
        const threshold = itemOffset * 0.5;

        // If scrolled to clones at the end, jump to beginning of original slides
        if (scrollLeft + clientWidth >= scrollWidth - threshold) {
          isScrolling = true;
          const currentIndex = Math.round(scrollLeft / itemOffset) - cloneCount;
          const newScrollLeft = (cloneCount + (currentIndex % totalBlocks)) * itemOffset;
          carousel.scrollLeft = newScrollLeft;
          setTimeout(() => { isScrolling = false; }, 50);
        }
        // If scrolled to clones at the beginning, jump to end of original slides  
        else if (scrollLeft <= threshold) {
          isScrolling = true;
          const currentIndex = Math.round(scrollLeft / itemOffset);
          const targetIndex = totalBlocks + currentIndex;
          carousel.scrollLeft = targetIndex * itemOffset;
          setTimeout(() => { isScrolling = false; }, 50);
        }
      }, 150);
    });

    // Start at the first original slide (after clones)
    scrollToOriginalPosition();

    // Recalculate position on window resize
    window.addEventListener('resize', function() {
      if (!isScrolling) {
        scrollToOriginalPosition();
      }
    });
  });
</script>

{%- comment -%}
------------------------------------------------------------------------------------------------------------------------
LIQUID
------------------------------------------------------------------------------------------------------------------------
{%- endcomment -%}

<div {% render 'section-properties' %}>
  <div class="testimonials">
    {%- if section.settings.title != blank -%}
      <div class="testimonials__header">
        <h2 class="testimonials__title">{{ section.settings.title }}</h2>
      </div>
    {%- endif -%}

    <div class="testimonials__slider-wrapper floating-controls-container">
      {%- assign slider_id = 'testimonials-' | append: section.id -%}
      
      <scroll-carousel id="{{ slider_id }}" class="testimonials__slider scroll-area is-scrollable" reveal-on-scroll="false">
        {%- comment -%} Duplicate slides at the beginning for infinite scroll effect {%- endcomment -%}
        {%- if section.blocks.size > 3 -%}
          {%- for block in section.blocks limit: 3 -%}
            <div class="testimonial-card scroll-area__item testimonial-card--clone" data-block-id="{{ block.id }}">
              {%- if block.settings.quote != blank -%}
                <div class="testimonial-card__quote">"</div>
              {%- endif -%}

              <div class="testimonial-card__content">
                {%- if block.settings.heading != blank -%}
                  <h3 class="testimonial-card__heading">{{ block.settings.heading }}</h3>
                {%- endif -%}

                {%- if block.settings.text != blank -%}
                  <div class="testimonial-card__text">
                    {{ block.settings.text }}
                  </div>
                {%- endif -%}
              </div>

              <div class="testimonial-card__footer">
                {%- if block.settings.image != blank -%}
                  <div class="testimonial-card__image">
                    {{- block.settings.image | image_url: width: 120 | image_tag: loading: 'lazy', widths: '60,120' -}}
                  </div>
                {%- endif -%}

                <div class="testimonial-card__author">
                  {%- if block.settings.author_name != blank -%}
                    <p class="testimonial-card__name">{{ block.settings.author_name }}</p>
                  {%- endif -%}

                  {%- if block.settings.author_meta != blank -%}
                    <p class="testimonial-card__meta">{{ block.settings.author_meta }}</p>
                  {%- endif -%}
                </div>
              </div>
            </div>
          {%- endfor -%}
        {%- endif -%}

        {%- comment -%} Original slides {%- endcomment -%}
        {%- for block in section.blocks -%}
          <div class="testimonial-card scroll-area__item" data-block-id="{{ block.id }}" {{ block.shopify_attributes }}>
            {%- if block.settings.quote != blank -%}
              <div class="testimonial-card__quote">"</div>
            {%- endif -%}

            <div class="testimonial-card__content">
              {%- if block.settings.heading != blank -%}
                <h3 class="testimonial-card__heading">{{ block.settings.heading }}</h3>
              {%- endif -%}

              {%- if block.settings.text != blank -%}
                <div class="testimonial-card__text">
                  {{ block.settings.text }}
                </div>
              {%- endif -%}
            </div>

            <div class="testimonial-card__footer">
              {%- if block.settings.image != blank -%}
                <div class="testimonial-card__image">
                  {{- block.settings.image | image_url: width: 120 | image_tag: loading: 'lazy', widths: '60,120' -}}
                </div>
              {%- endif -%}

              <div class="testimonial-card__author">
                {%- if block.settings.author_name != blank -%}
                  <p class="testimonial-card__name">{{ block.settings.author_name }}</p>
                {%- endif -%}

                {%- if block.settings.author_meta != blank -%}
                  <p class="testimonial-card__meta">{{ block.settings.author_meta }}</p>
                {%- endif -%}
              </div>
            </div>
          </div>
        {%- endfor -%}

        {%- comment -%} Duplicate slides at the end for infinite scroll effect {%- endcomment -%}
        {%- if section.blocks.size > 3 -%}
          {%- for block in section.blocks limit: 3 -%}
            <div class="testimonial-card scroll-area__item testimonial-card--clone" data-block-id="{{ block.id }}">
              {%- if block.settings.quote != blank -%}
                <div class="testimonial-card__quote">"</div>
              {%- endif -%}

              <div class="testimonial-card__content">
                {%- if block.settings.heading != blank -%}
                  <h3 class="testimonial-card__heading">{{ block.settings.heading }}</h3>
                {%- endif -%}

                {%- if block.settings.text != blank -%}
                  <div class="testimonial-card__text">
                    {{ block.settings.text }}
                  </div>
                {%- endif -%}
              </div>

              <div class="testimonial-card__footer">
                {%- if block.settings.image != blank -%}
                  <div class="testimonial-card__image">
                    {{- block.settings.image | image_url: width: 120 | image_tag: loading: 'lazy', widths: '60,120' -}}
                  </div>
                {%- endif -%}

                <div class="testimonial-card__author">
                  {%- if block.settings.author_name != blank -%}
                    <p class="testimonial-card__name">{{ block.settings.author_name }}</p>
                  {%- endif -%}

                  {%- if block.settings.author_meta != blank -%}
                    <p class="testimonial-card__meta">{{ block.settings.author_meta }}</p>
                  {%- endif -%}
                </div>
              </div>
            </div>
          {%- endfor -%}
        {%- endif -%}
      </scroll-carousel>

      <button is="prev-button" class="circle-button testimonials-scallop-button" aria-controls="{{ slider_id }}">
        <span class="sr-only">{{ 'general.accessibility.previous' | t }}</span>
        {%- render 'icon-arrow-left-scallop' -%}
      </button>

      <button is="next-button" class="circle-button testimonials-scallop-button" aria-controls="{{ slider_id }}">
        <span class="sr-only">{{ 'general.accessibility.next' | t }}</span>
        {%- render 'icon-arrow-right-scallop' -%}
      </button>
    </div>
  </div>
</div>

{% schema %}
{
  "name": "Testimonials",
  "class": "shopify-section--testimonials",
  "tag": "section",
  "disabled_on": {
    "templates": ["password"],
    "groups": ["header", "custom.overlay"]
  },
  "settings": [
    {
      "type": "header",
      "content": "Section title"
    },
    {
      "type": "inline_richtext",
      "id": "title",
      "label": "Title",
      "default": "They say it <em>better</em> than we do."
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "Title color",
      "default": "#000000"
    },
    {
      "type": "range",
      "id": "title_font_size_mobile",
      "label": "Title font size (mobile)",
      "min": 24,
      "max": 60,
      "step": 2,
      "unit": "px",
      "default": 32
    },
    {
      "type": "range",
      "id": "title_font_size_desktop",
      "label": "Title font size (desktop)",
      "min": 32,
      "max": 80,
      "step": 2,
      "unit": "px",
      "default": 48
    },
    {
      "type": "range",
      "id": "title_font_weight",
      "label": "Title font weight",
      "min": 400,
      "max": 700,
      "step": 100,
      "default": 400
    },
    {
      "type": "select",
      "id": "title_font_style",
      "label": "Title font style",
      "options": [
        {
          "value": "normal",
          "label": "Normal"
        },
        {
          "value": "italic",
          "label": "Italic"
        }
      ],
      "default": "normal"
    },
    {
      "type": "header",
      "content": "Card styling"
    },
    {
      "type": "range",
      "id": "card_border_radius",
      "label": "Card border radius",
      "min": 0,
      "max": 50,
      "step": 2,
      "unit": "px",
      "default": 24
    },
    {
      "type": "range",
      "id": "card_padding_mobile",
      "label": "Card padding (mobile)",
      "min": 20,
      "max": 60,
      "step": 4,
      "unit": "px",
      "default": 32
    },
    {
      "type": "range",
      "id": "card_padding_desktop",
      "label": "Card padding (desktop)",
      "min": 32,
      "max": 80,
      "step": 4,
      "unit": "px",
      "default": 40
    },
    {
      "type": "header",
      "content": "Card content"
    },
    {
      "type": "range",
      "id": "quote_size_mobile",
      "label": "Quote size (mobile)",
      "min": 40,
      "max": 100,
      "step": 4,
      "unit": "px",
      "default": 60
    },
    {
      "type": "range",
      "id": "quote_size_desktop",
      "label": "Quote size (desktop)",
      "min": 60,
      "max": 120,
      "step": 4,
      "unit": "px",
      "default": 80
    },
    {
      "type": "range",
      "id": "heading_size_mobile",
      "label": "Heading size (mobile)",
      "min": 16,
      "max": 32,
      "step": 2,
      "unit": "px",
      "default": 20
    },
    {
      "type": "range",
      "id": "heading_size_desktop",
      "label": "Heading size (desktop)",
      "min": 20,
      "max": 40,
      "step": 2,
      "unit": "px",
      "default": 24
    },
    {
      "type": "range",
      "id": "heading_weight",
      "label": "Heading font weight",
      "min": 400,
      "max": 700,
      "step": 100,
      "default": 600
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text color",
      "default": "#000000"
    },
    {
      "type": "range",
      "id": "text_size_mobile",
      "label": "Text size (mobile)",
      "min": 14,
      "max": 20,
      "step": 1,
      "unit": "px",
      "default": 16
    },
    {
      "type": "range",
      "id": "text_size_desktop",
      "label": "Text size (desktop)",
      "min": 16,
      "max": 24,
      "step": 1,
      "unit": "px",
      "default": 18
    },
    {
      "type": "color",
      "id": "author_color",
      "label": "Author name color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "meta_color",
      "label": "Meta text color",
      "default": "#666666"
    },
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background color",
      "default": "#FFFFFF"
    },
    {
      "type": "range",
      "id": "padding_mobile",
      "label": "Section padding (mobile)",
      "min": 30,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 60
    },
    {
      "type": "range",
      "id": "padding_desktop",
      "label": "Section padding (desktop)",
      "min": 60,
      "max": 200,
      "step": 10,
      "unit": "px",
      "default": 100
    },
    {
      "type": "range",
      "id": "header_spacing_mobile",
      "label": "Header spacing (mobile)",
      "min": 20,
      "max": 80,
      "step": 4,
      "unit": "px",
      "default": 40
    },
    {
      "type": "range",
      "id": "header_spacing_desktop",
      "label": "Header spacing (desktop)",
      "min": 40,
      "max": 120,
      "step": 4,
      "unit": "px",
      "default": 60
    }
  ],
  "blocks": [
    {
      "type": "testimonial",
      "name": "Testimonial",
      "settings": [
        {
          "type": "color",
          "id": "card_background",
          "label": "Card background color",
          "default": "#E8D5F2"
        },
        {
          "type": "color",
          "id": "heading_color",
          "label": "Heading color",
          "default": "#E07A5F"
        },
        {
          "type": "checkbox",
          "id": "quote",
          "label": "Show quote mark",
          "default": true
        },
        {
          "type": "text",
          "id": "heading",
          "label": "Heading",
          "default": "Finally a bra that fits me the right way."
        },
        {
          "type": "richtext",
          "id": "text",
          "label": "Text",
          "default": "<p>It's supportive, doesn't dig into my skin and it looks great too. I've never felt more <em>confident</em>, or more <em>comfortable!</em></p>"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Author image"
        },
        {
          "type": "text",
          "id": "author_name",
          "label": "Author name",
          "default": "Nita Sharma"
        },
        {
          "type": "text",
          "id": "author_meta",
          "label": "Author meta",
          "default": "Wore: 36D | Real Fit: 32G"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Testimonials",
      "category": "Content",
      "blocks": [
        {
          "type": "testimonial"
        },
        {
          "type": "testimonial"
        },
        {
          "type": "testimonial"
        }
      ]
    }
  ]
}
{% endschema %}
