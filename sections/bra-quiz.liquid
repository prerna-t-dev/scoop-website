{%- comment -%}
----------------------------------------------------------------------------------------------------------------------
BRA QUIZ SECTION
----------------------------------------------------------------------------------------------------------------------
A step-by-step quiz form that collects 5 measurements and recommends a bra size.

SETUP INSTRUCTIONS:
1. Add blocks for each measurement step (measurement_step) and question step (question_step)
2. Add one email_step block as the final step
3. Update the calculateBraSize() function in the JavaScript with your size calculation logic

STORING BRA SIZE IN CUSTOMER DATA:
The customer form automatically stores the bra size in customer tags:
- Tag: "bra-quiz" (indicates customer completed the quiz)
- Tag: "bra-size-{size}" (e.g., "bra-size-32FF")
- Customer note: JSON with bra_size, measurements, and calculated_at timestamp

No webhooks or apps needed! The tags are set directly via the form (same approach as newsletter form).
{%- endcomment -%}

<div class="bra-quiz" id="bra-quiz-{{ section.id }}">
  <div class="bra-quiz__container container">
    {%- comment -%} Progress Indicator {%- endcomment -%}
    <div class="bra-quiz__progress">
      <div class="bra-quiz__progress-bar">
        {%- for i in (1..6) -%}
          <div class="bra-quiz__progress-step {% if forloop.index == 1 %}bra-quiz__progress-step--active{% endif %}" data-step="{{ forloop.index }}"></div>
        {%- endfor -%}
      </div>
    </div>

    {%- comment -%} Quiz Steps {%- endcomment -%}
    <div class="bra-quiz__steps">
      {%- for block in section.blocks -%}
        {%- case block.type -%}
          {%- when 'measurement_step' -%}
            <div class="bra-quiz__step {% if forloop.first %}bra-quiz__step--active{% endif %}" data-step="{{ forloop.index }}" {{ block.shopify_attributes }}>
              <div class="bra-quiz__step-card">
                {%- comment -%} Step Header {%- endcomment -%}
                <div class="bra-quiz__step-header">
                  <div class="bra-quiz__step-number">
                    <span class="bra-quiz__step-label">STEP {{ forloop.index }}</span>
                    {%- if block.settings.step_icon != blank -%}
                      <span class="bra-quiz__step-icon">{{ block.settings.step_icon }}</span>
                    {%- endif -%}
                  </div>
                  <h2 class="bra-quiz__step-title">{{ block.settings.step_title }}</h2>
                </div>

                {%- comment -%} Step Content {%- endcomment -%}
                <div class="bra-quiz__step-content">
                  {%- comment -%} Instructions {%- endcomment -%}
                  {%- if block.settings.instructions != blank -%}
                    <div class="bra-quiz__instructions">
                      {{ block.settings.instructions }}
                    </div>
                  {%- endif -%}

                  {%- comment -%} Input Field {%- endcomment -%}
                  <div class="bra-quiz__input-wrapper">
                    <input 
                      type="number" 
                      id="measurement-{{ forloop.index }}" 
                      class="bra-quiz__input" 
                      placeholder="ENTER MEASUREMENTS IN INCHES"
                      step="0.1"
                      min="0"
                      data-measurement="{{ block.settings.measurement_key }}"
                    >
                    <button type="button" class="bra-quiz__next-btn" data-next-step>
                      {%- if block.settings.next_icon != blank -%}
                        {{ block.settings.next_icon }}
                      {%- else -%}
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M9 18L15 12L9 6" stroke="#A073B7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                      {%- endif -%}
                    </button>
                  </div>

                  {%- comment -%} Illustration {%- endcomment -%}
                  {%- if block.settings.illustration != blank -%}
                    <div class="bra-quiz__illustration">
                      {{ block.settings.illustration }}
                    </div>
                  {%- endif -%}
                </div>

                {%- comment -%} Large Step Number {%- endcomment -%}
                <div class="bra-quiz__step-number-large">
                  {{ forloop.index | prepend: '0' | slice: -2, 2 }}
                </div>
              </div>
            </div>

          {%- when 'question_step' -%}
            <div class="bra-quiz__step {% if forloop.index == 5 %}bra-quiz__step--active{% endif %}" data-step="{{ forloop.index }}" {{ block.shopify_attributes }}>
              <div class="bra-quiz__step-card">
                <div class="bra-quiz__step-header">
                  <div class="bra-quiz__step-number">
                    <span class="bra-quiz__step-label">STEP {{ forloop.index }}</span>
                    {%- if block.settings.step_icon != blank -%}
                      <span class="bra-quiz__step-icon">{{ block.settings.step_icon }}</span>
                    {%- endif -%}
                  </div>
                  <h2 class="bra-quiz__step-title">{{ block.settings.step_title }}</h2>
                </div>

                <div class="bra-quiz__step-content">
                  {%- if block.settings.question != blank -%}
                    <div class="bra-quiz__question">
                      {{ block.settings.question }}
                    </div>
                  {%- endif -%}

                  {%- comment -%} Radio Options {%- endcomment -%}
                  <div class="bra-quiz__options">
                    {%- for i in (1..3) -%}
                      {%- assign option_key = 'option_' | append: i | append: '_text' -%}
                      {%- assign option_value = 'option_' | append: i | append: '_value' -%}
                      {%- if block.settings[option_key] != blank -%}
                        <label class="bra-quiz__option">
                          <input 
                            type="radio" 
                            name="question-{{ forloop.parentloop.index }}" 
                            value="{{ block.settings[option_value] }}"
                            data-question="{{ block.settings.question_key }}"
                            class="bra-quiz__radio"
                          >
                          <span class="bra-quiz__option-text">{{ block.settings[option_key] }}</span>
                        </label>
                      {%- endif -%}
                    {%- endfor -%}
                  </div>

                  {%- comment -%} Continue Button {%- endcomment -%}
                  <div class="bra-quiz__continue-wrapper">
                    <button type="button" class="bra-quiz__continue-btn" data-next-step>
                      {%- if block.settings.continue_icon != blank -%}
                        {{ block.settings.continue_icon }}
                      {%- else -%}
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M9 18L15 12L9 6" stroke="#A073B7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                      {%- endif -%}
                    </button>
                  </div>

                  {%- if block.settings.illustration != blank -%}
                    <div class="bra-quiz__illustration">
                      {{ block.settings.illustration }}
                    </div>
                  {%- endif -%}
                </div>

                <div class="bra-quiz__step-number-large">
                  {{ forloop.index | prepend: '0' | slice: -2, 2 }}
                </div>
              </div>
            </div>

          {%- when 'results_step' -%}
            <div class="bra-quiz__step bra-quiz__step--results" data-step="{{ forloop.index }}" {{ block.shopify_attributes }}>
              <div class="bra-quiz__step-card">
                <div class="bra-quiz__step-header">
                  <div class="bra-quiz__step-number">
                    <span class="bra-quiz__step-label">YOUR SIZE</span>
                  </div>
                  <h2 class="bra-quiz__step-title">{{ block.settings.step_title | default: "Your Recommended Bra Size" }}</h2>
                </div>

                <div class="bra-quiz__step-content">
                  <div class="bra-quiz__results">
                    <div class="bra-quiz__size-display" id="bra-quiz-size-display">
                      <span class="bra-quiz__size-value">--</span>
                    </div>
                    {%- if block.settings.description != blank -%}
                      <p class="bra-quiz__results-description">{{ block.settings.description }}</p>
                    {%- endif -%}
                  </div>

                  {%- comment -%} Continue to Email Button {%- endcomment -%}
                  <div class="bra-quiz__continue-wrapper">
                    <button type="button" class="bra-quiz__continue-btn bra-quiz__continue-btn--large" data-next-step>
                      {{ block.settings.button_text | default: "Continue" }}
                    </button>
                  </div>
                </div>
              </div>
            </div>

          {%- when 'email_step' -%}
            <div class="bra-quiz__step bra-quiz__step--email" data-step="{{ forloop.index }}" {{ block.shopify_attributes }}>
              <div class="bra-quiz__step-card{% if form.posted_successfully? %} bra-quiz__step-card--success{% endif %}">
                {%- unless form.posted_successfully? -%}
                  <div class="bra-quiz__step-header" data-step-header>
                    <div class="bra-quiz__step-number">
                      <span class="bra-quiz__step-label">FINAL STEP</span>
                    </div>
                    <h2 class="bra-quiz__step-title">{{ block.settings.step_title | default: "Enter your email" }}</h2>
                  </div>
                {%- endunless -%}

                <div class="bra-quiz__step-content" data-step-content>
                  {%- if block.settings.description != blank and form.posted_successfully? == false -%}
                    <p class="bra-quiz__email-description">{{ block.settings.description }}</p>
                  {%- endif -%}

                  {%- form 'customer', id: 'bra-quiz-form', class: 'bra-quiz__form' -%}
                    {%- if form.posted_successfully? -%}
                      <div class="bra-quiz__success">
                        <p>{{ block.settings.success_message | default: "Thank you! Your bra size has been calculated and saved." }}</p>
                        <div id="bra-quiz-result" class="bra-quiz__success-size">
                          <div class="bra-quiz__size-label">Your Recommended Bra Size</div>
                          <div class="bra-quiz__size-value">--</div>
                        </div>
                      </div>
                    {%- else -%}
                      {%- if form.errors -%}
                        <div class="bra-quiz__errors">
                          {{ form.errors | default_errors }}
                        </div>
                      {%- endif -%}

                      <div class="bra-quiz__email-wrapper">
                        <input 
                          type="email" 
                          name="contact[email]" 
                          id="bra-quiz-email" 
                          class="bra-quiz__email-input" 
                          placeholder="EMAIL ID"
                          value="{{ customer.email }}"
                          required
                          autocomplete="email"
                        >
                        <button type="submit" class="bra-quiz__submit-btn">
                          {{ block.settings.button_text | default: "FIND YOUR SIZE" }}
                        </button>
                      </div>

                      {%- comment -%} Privacy Consent {%- endcomment -%}
                      {%- if block.settings.show_privacy_consent -%}
                        <label class="bra-quiz__privacy-consent">
                          <input type="checkbox" name="contact[accepts_marketing]" value="true" id="bra-quiz-consent" required>
                          <span>{{ block.settings.privacy_text | default: "I consent to the storage of my information in order to calculate my size and improve the accuracy of the calculator. For details on how your data is stored and used, read our Privacy Policy." }}</span>
                        </label>
                      {%- endif -%}

                      {%- comment -%} 
                        Hidden fields for storing measurements and bra size
                        Note: Matches Shopify newsletter handling using contact fields
                        Tags will be set via JavaScript before form submission
                      {%- endcomment -%}
                      <input type="hidden" name="contact[tags]" id="bra-quiz-contact-tags" value="bra-quiz">
                      <input type="hidden" name="contact[body]" id="bra-quiz-contact-body" value="">
                      <input type="hidden" id="bra-quiz-measurements" value="">
                      <input type="hidden" id="bra-quiz-size" value="">
                    {%- endif -%}
                  {%- endform -%}
                </div>
              </div>
            </div>
        {%- endcase -%}
      {%- endfor -%}
    </div>
  </div>
</div>

<script src="{{ 'bra-quiz.js' | asset_url }}" defer></script>

{% schema %}
{
  "name": "Bra Quiz",
  "tag": "section",
  "class": "shopify-section--bra-quiz",
  "blocks": [
    {
      "type": "measurement_step",
      "name": "Measurement Step",
      "settings": [
        {
          "type": "text",
          "id": "step_title",
          "label": "Step Title",
          "default": "Snug Underband"
        },
        {
          "type": "text",
          "id": "measurement_key",
          "label": "Measurement Key",
          "info": "Unique identifier for this measurement (e.g., snug_underband)",
          "default": "snug_underband"
        },
        {
          "type": "richtext",
          "id": "instructions",
          "label": "Instructions",
          "default": "<p>Measure around your body, right where your breasts meet your chest wall, where your bra band should sit.</p><p>Remember to exhale and relax your shoulders. This measurement should be comfortably supportive.</p>"
        },
        {
          "type": "html",
          "id": "illustration",
          "label": "Illustration (HTML/SVG)",
          "info": "Add SVG or HTML illustration for this step"
        },
        {
          "type": "text",
          "id": "step_icon",
          "label": "Step Icon",
          "info": "Optional icon or emoji for the step"
        },
        {
          "type": "html",
          "id": "next_icon",
          "label": "Next Button Icon (SVG)",
          "info": "Optional custom SVG icon for next button"
        }
      ]
    },
    {
      "type": "question_step",
      "name": "Question Step",
      "settings": [
        {
          "type": "text",
          "id": "step_title",
          "label": "Step Title",
          "default": "And lastly..."
        },
        {
          "type": "text",
          "id": "question_key",
          "label": "Question Key",
          "info": "Unique identifier for this question (e.g., breast_space)",
          "default": "breast_space"
        },
        {
          "type": "richtext",
          "id": "question",
          "label": "Question",
          "default": "<p>When you lean over at 90 degrees and let your breasts hang freely, how much space is naturally between them?</p>"
        },
        {
          "type": "text",
          "id": "option_1_text",
          "label": "Option 1 Text",
          "default": "There is no space/ my breasts touch"
        },
        {
          "type": "text",
          "id": "option_1_value",
          "label": "Option 1 Value",
          "default": "no_space"
        },
        {
          "type": "text",
          "id": "option_2_text",
          "label": "Option 2 Text",
          "default": "There is about 1-2 fingers worth of space between my breasts"
        },
        {
          "type": "text",
          "id": "option_2_value",
          "label": "Option 2 Value",
          "default": "1-2_fingers"
        },
        {
          "type": "text",
          "id": "option_3_text",
          "label": "Option 3 Text",
          "default": "There is more than 2 fingers worth of space between my breasts"
        },
        {
          "type": "text",
          "id": "option_3_value",
          "label": "Option 3 Value",
          "default": "more_than_2_fingers"
        },
        {
          "type": "html",
          "id": "illustration",
          "label": "Illustration (HTML/SVG)"
        },
        {
          "type": "text",
          "id": "step_icon",
          "label": "Step Icon"
        },
        {
          "type": "html",
          "id": "continue_icon",
          "label": "Continue Button Icon (SVG)",
          "info": "Optional custom SVG icon for continue button"
        }
      ]
    },
    {
      "type": "results_step",
      "name": "Results Display Step",
      "limit": 1,
      "settings": [
        {
          "type": "text",
          "id": "step_title",
          "label": "Step Title",
          "default": "Your Recommended Bra Size"
        },
        {
          "type": "richtext",
          "id": "description",
          "label": "Description",
          "default": "<p>Based on your measurements, here's your recommended bra size.</p>"
        },
        {
          "type": "text",
          "id": "button_text",
          "label": "Continue Button Text",
          "default": "Continue"
        }
      ]
    },
    {
      "type": "email_step",
      "name": "Email Collection Step",
      "limit": 1,
      "settings": [
        {
          "type": "text",
          "id": "step_title",
          "label": "Step Title",
          "default": "Enter your email"
        },
        {
          "type": "text",
          "id": "description",
          "label": "Description",
          "default": "To receive your bra size and personalised recommendations"
        },
        {
          "type": "text",
          "id": "button_text",
          "label": "Button Text",
          "default": "FIND YOUR SIZE"
        },
        {
          "type": "checkbox",
          "id": "show_privacy_consent",
          "label": "Show Privacy Consent",
          "default": true
        },
        {
          "type": "richtext",
          "id": "privacy_text",
          "label": "Privacy Consent Text",
          "default": "<p>I consent to the storage of my information in order to calculate my size and improve the accuracy of the calculator. For details on how your data is stored and used, read our <a href='/policies/privacy-policy'>Privacy Policy</a>.</p>"
        },
        {
          "type": "text",
          "id": "success_message",
          "label": "Success Message",
          "default": "Thank you! Your bra size has been calculated and saved."
        }
      ]
    }
  ],
  "settings": [
    {
      "type": "header",
      "content": "Quiz Settings"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Find Your Perfect Bra Size"
    }
  ],
  "presets": [
    {
      "name": "Bra Quiz"
    }
  ]
}
{% endschema %}

