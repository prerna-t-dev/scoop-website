{%- render 'section-spacing-collapsing' -%}

{%- comment -%}
------------------------------------------------------------------------------------------------------------------------
CSS
------------------------------------------------------------------------------------------------------------------------
{%- endcomment -%}
<style>
  #shopify-section-{{ section.id }} .fitting-details {
    display: grid;
    grid-template-columns: 1fr;
    gap: 0;
    max-width: 1200px;
    margin-left: auto;
    margin-right: auto;
  }

  #shopify-section-{{ section.id }} .fitting-details.bleed-right {
    margin-inline-end: 0 !important;
    padding-inline-end: 0 !important;
  }

  #shopify-section-{{ section.id }} .fitting-details__left {
    background: #FFFFFF;
    /* padding: 40px 24px; */
  }

  #shopify-section-{{ section.id }} .fitting-details__right {
    background: transparent;
    padding: 0;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  @media screen and (min-width: 700px) {
    #shopify-section-{{ section.id }} .fitting-details__right {
      background: {{ section.settings.right_background_color | color_modify: 'alpha', 0.4 }};
      padding: 40px 24px;
    }
  }

  #shopify-section-{{ section.id }} .fitting-details__heading {
    font-family: var(--text-font-family);
    font-size: 30px;
    font-weight: 600;
    line-height: 1.1;
    margin: 0 0 16px 0;
    color: #000000;
  }

  #shopify-section-{{ section.id }} .fitting-details__subheading {
    font-family: var(--text-font-family);
    font-size: 14px;
    font-weight: 400;
    line-height: 1.5;
    margin: 0 0 24px 0;
    color: #000000;
  }

  #shopify-section-{{ section.id }} .fitting-details__separator {
    height: 1px;
    background: #D6D6D6;
    margin: 24px 0;
    border: none;
  }

  @media screen and (min-width: 700px) {
    #shopify-section-{{ section.id }} .fitting-details__separator:last-of-type {
      display: none;
    }
  }

  #shopify-section-{{ section.id }} .fitting-details__fee-section {
    display: flex;
    align-items: flex-start;
    gap: 24px;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }

  #shopify-section-{{ section.id }} .fitting-details__fee-content {
    flex: 1;
  }

  #shopify-section-{{ section.id }} .fitting-details__fee-label {
    font-family: var(--text-font-family);
    font-size: 10px;
    line-height: 1.1;
    font-weight: 400;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin: 0 0 4px 0;
    color: #000000;
  }

  #shopify-section-{{ section.id }} .fitting-details__fee-original {
    font-family: var(--text-font-family);
    font-size: 14px;
    font-weight: 400;
    text-decoration: line-through;
    color: #000000;
    margin: 0;
  }

  #shopify-section-{{ section.id }} .fitting-details__fee-current {
    font-family: var(--heading-font-family);
    font-size: 24px;
    font-weight: 400;
    color: #000000;
    margin: 4px 0 0 0;
  }

  #shopify-section-{{ section.id }} .fitting-details__book-button {
    font-family: var(--text-font-family);
    font-size: 12px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 14px 28px;
    background: #000000;
    color: #FFFFFF;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: opacity 0.2s;
    white-space: nowrap;
    box-shadow: 1px 2px 4px 0px rgba(0, 0, 0, 0.17) !important;
  }

  #shopify-section-{{ section.id }} .fitting-details__book-button:hover {
    opacity: 0.8;
  }

  #shopify-section-{{ section.id }} .fitting-details__book-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  #shopify-section-{{ section.id }} .fitting-details__details-grid {
    display: flex;
    flex-direction: column;
    gap: 24px;
    margin-bottom: 24px;
  }

  #shopify-section-{{ section.id }} .fitting-details__details-row {
    display: flex;
    gap: 24px;
  }

  #shopify-section-{{ section.id }} .fitting-details__detail-item {
    display: flex;
    flex-direction: column;
    flex: 1;
  }

  #shopify-section-{{ section.id }} .fitting-details__detail-label {
    font-family: var(--text-font-family);
    font-size: 10px;
    line-height: 1.1;
    font-weight: 400;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin: 0 0 4px 0;
    color: #000000;
  }

  #shopify-section-{{ section.id }} .fitting-details__detail-value {
    font-family: var(--heading-font-family);
    font-size: 24px;
    line-height: 1.3 !important;
    font-weight: 400;
    color: #000000;
    margin: 0;
  }

  #shopify-section-{{ section.id }} .fitting-details__detail-note {
    font-family: var(--text-font-family);
    font-size: 12px;
    font-weight: 400;
    line-height: 1.4;
    color: #7E7E7E;
    margin: 4px 0 0 0;
  }

  #shopify-section-{{ section.id }} .fitting-details__covered-heading {
    font-family: var(--heading-font-family);
    font-size: 35px;
    font-weight: 400;
    line-height: 1.2;
    margin: 0 0 12px 0;
    color: #000000;
  }

  #shopify-section-{{ section.id }} .fitting-details__covered-content {
    font-family: var(--text-font-family);
    font-size: 12px;
    font-weight: 400;
    line-height: 1.4;
    color: #000000;
    margin: 0;
  }

  #shopify-section-{{ section.id }} .fitting-details__covered-content p {
    margin: 0 0 12px 0;
  }

  #shopify-section-{{ section.id }} .fitting-details__covered-content p:last-child {
    margin-bottom: 0;
  }

  @media screen and (min-width: 700px) {
    #shopify-section-{{ section.id }} {
      padding-inline-end: 0 !important;
      padding-right: 0 !important;
    }

    #shopify-section-{{ section.id }} .section-stack {
      padding-inline-end: 0 !important;
      padding-right: 0 !important;
    }

    #shopify-section-{{ section.id }} .fitting-details {
      grid-template-columns: 2fr 1fr;
      gap: 0;
      max-width: none;
      margin-left: 0;
      margin-right: 0;
    }

    #shopify-section-{{ section.id }} .fitting-details.bleed-right {
      margin-inline-end: calc(-1 * var(--container-outer-width, 0px)) !important;
      padding-inline-end: 0 !important;
      padding-right: 0 !important;
    }

    #shopify-section-{{ section.id }} .fitting-details__left {
      padding: 60px 48px;
      padding-bottom: 0;
      padding-right: 70px;
    }

    #shopify-section-{{ section.id }} .fitting-details__right {
      padding: 60px 65px;
    }

    #shopify-section-{{ section.id }} .fitting-details__heading {
      font-size: 36px;
      margin-bottom: 24px;
      width: 80%;
    }

    #shopify-section-{{ section.id }} .fitting-details__subheading {
      font-size: 18px;
      margin-bottom: 32px;
      width: 80%;
    }

    #shopify-section-{{ section.id }} .fitting-details__separator {
      margin: 32px 0;
      width: 80%;
    }

    #shopify-section-{{ section.id }} .fitting-details__fee-section {
      margin-bottom: 24px;
      width: 80%;
    }

    #shopify-section-{{ section.id }} .fitting-details__fee-content {
      min-width: 200px;
    }

    #shopify-section-{{ section.id }} .fitting-details__fee-label {
      font-size: 13px;
    }

    #shopify-section-{{ section.id }} .fitting-details__fee-current {
      font-size: 30px;
    }

    #shopify-section-{{ section.id }} .fitting-details__book-button {
      font-size: 13px;
      padding: 16px 32px;
    }

    #shopify-section-{{ section.id }} .fitting-details__details-grid {
      flex-direction: row;
      gap: 32px;
      margin-bottom: 32px;
      align-items: flex-start;
    }

    #shopify-section-{{ section.id }} .fitting-details__details-row {
      flex: 0 0 auto;
      width: 50%;
    }

    #shopify-section-{{ section.id }} .fitting-details__detail-item {
      flex: 1;
    }

    #shopify-section-{{ section.id }} .fitting-details__detail-label {
      font-size: 13px;
    }

    #shopify-section-{{ section.id }} .fitting-details__detail-value {
      font-size: 30px;
    }

    #shopify-section-{{ section.id }} .fitting-details__detail-note {
      font-size: 15px;
    }

    #shopify-section-{{ section.id }} .fitting-details__covered-heading {
      font-size: 42px;
      margin-bottom: 24px;
    }

    #shopify-section-{{ section.id }} .fitting-details__covered-content {
      font-size: 14px;
    }
  }
</style>

<div {% render 'section-properties' %}>
  <div class="section-stack">
    <div class="fitting-details bleed-right">
      <div class="fitting-details__left">
        {%- if section.settings.heading != blank -%}
          <h2 class="fitting-details__heading">{{ section.settings.heading }}</h2>
        {%- endif -%}

        {%- if section.settings.subheading != blank -%}
          <p class="fitting-details__subheading">{{ section.settings.subheading }}</p>
        {%- endif -%}

        <hr class="fitting-details__separator">

        {%- if section.settings.product != blank -%}
          {%- assign product = section.settings.product -%}
          {%- assign selected_variant = product.selected_or_first_available_variant -%}
          
          <div class="fitting-details__fee-section">
            <div class="fitting-details__fee-content">
              <p class="fitting-details__fee-label">CONSULTATION FEE</p>
              {%- if selected_variant.compare_at_price > selected_variant.price -%}
                <p class="fitting-details__fee-original">{{ selected_variant.compare_at_price | money }}</p>
              {%- endif -%}
              <p class="fitting-details__fee-current">{{ selected_variant.price | money }}</p>
            </div>
            <button 
              type="button" 
              class="fitting-details__book-button"
              data-product-id="{{ selected_variant.id }}"
              {% unless selected_variant.available %}disabled{% endunless %}>
              BOOK CONSULTATION
            </button>
          </div>

          <div class="fitting-details__details-grid">
            <div class="fitting-details__details-row">
              {%- if section.settings.location != blank -%}
                <div class="fitting-details__detail-item">
                  <p class="fitting-details__detail-label">LOCATION</p>
                  <p class="fitting-details__detail-value">{{ section.settings.location }}</p>
                </div>
              {%- endif -%}

              {%- if section.settings.duration != blank -%}
                <div class="fitting-details__detail-item">
                  <p class="fitting-details__detail-label">DURATION</p>
                  <p class="fitting-details__detail-value">{{ section.settings.duration }}</p>
                </div>
              {%- endif -%}
            </div>

            {%- if section.settings.note != blank -%}
              <div class="fitting-details__detail-item">
                <p class="fitting-details__detail-label">NOTE</p>
                <p class="fitting-details__detail-note">{{ section.settings.note }}</p>
              </div>
            {%- endif -%}
          </div>

          <hr class="fitting-details__separator">
        {%- endif -%}
      </div>

      <div class="fitting-details__right">
        {%- if section.settings.covered_heading != blank -%}
          <h3 class="fitting-details__covered-heading">{{ section.settings.covered_heading }}</h3>
        {%- endif -%}

        {%- if section.settings.covered_content != blank -%}
          <div class="fitting-details__covered-content">
            {{ section.settings.covered_content }}
          </div>
        {%- endif -%}
      </div>
    </div>
  </div>
</div>

<script>
  (function() {
    const section = document.querySelector('#shopify-section-{{ section.id }}');
    if (!section) return;

    const bookButton = section.querySelector('.fitting-details__book-button');
    if (!bookButton) return;

    bookButton.addEventListener('click', async function(e) {
      e.preventDefault();
      
      if (this.disabled) return;

      const variantId = this.getAttribute('data-product-id');
      if (!variantId) return;

      // Disable button during request
      this.disabled = true;
      const originalText = this.textContent;
      this.textContent = 'ADDING...';

      try {
        // Prepare sections to bundle
        let sectionsToBundle = ['variant-added'];
        document.documentElement.dispatchEvent(new CustomEvent('cart:prepare-bundled-sections', { 
          bubbles: true, 
          detail: { sections: sectionsToBundle } 
        }));

        const formData = new FormData();
        formData.append('id', variantId);
        formData.append('quantity', 1);
        formData.append('sections', sectionsToBundle.join(','));
        formData.append('sections_url', `${Shopify.routes.root}variants/${variantId}`);

        const response = await fetch(`${Shopify.routes.root}cart/add.js`, {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        });

        const responseJson = await response.json();

        if (response.ok) {
          // Fetch the full cart
          const cartContent = await (await fetch(`${Shopify.routes.root}cart.js`)).json();
          
          // Merge sections if available
          if (responseJson.sections) {
            cartContent.sections = responseJson.sections;
          }

          // Trigger cart update event with full cart data
          document.documentElement.dispatchEvent(new CustomEvent('cart:change', {
            bubbles: true,
            detail: {
              baseEvent: 'variant:add',
              cart: cartContent
            }
          }));

          // Open cart drawer if it exists
          const cartDrawer = document.querySelector('cart-drawer');
          if (cartDrawer) {
            cartDrawer.show();
          }

          // Reset button
          this.textContent = originalText;
          this.disabled = false;
        } else {
          alert(responseJson.description || 'Unable to add product to cart');
          this.textContent = originalText;
          this.disabled = false;
        }
      } catch (error) {
        console.error('Error adding to cart:', error);
        alert('An error occurred. Please try again.');
        this.textContent = originalText;
        this.disabled = false;
      }
    });
  })();
</script>

{% schema %}
{
  "name": "Fitting details",
  "class": "shopify-section--fitting-details",
  "tag": "section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Expert advice from your couch."
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Subheading",
      "default": "A private virtual consultation with our trained bra fitter."
    },
    {
      "type": "product",
      "id": "product",
      "label": "Consultation product"
    },
    {
      "type": "text",
      "id": "location",
      "label": "Location",
      "default": "Online"
    },
    {
      "type": "text",
      "id": "duration",
      "label": "Duration",
      "default": "30 mins"
    },
    {
      "type": "textarea",
      "id": "note",
      "label": "Note",
      "default": "Once you place your fitting order with us, we will get in touch to confirm the payment and schedule a time of your preference."
    },
    {
      "type": "text",
      "id": "covered_heading",
      "label": "What's covered heading",
      "default": "What's covered?"
    },
    {
      "type": "richtext",
      "id": "covered_content",
      "label": "What's covered content",
      "default": "<p>We'll begin with a conversation to understand your current bra troubles and pain points, and our fitter will then guide you through taking a series of measurements to calculate your size.</p><p>You will then be provided with personalised recommendations of styles and features to consider while shopping for your next bra.</p>"
    },
    {
      "type": "color",
      "id": "right_background_color",
      "label": "Right section background color",
      "default": "#F8EEEC"
    }
  ],
  "presets": [
    {
      "name": "Fitting details"
    }
  ]
}
{% endschema %}

