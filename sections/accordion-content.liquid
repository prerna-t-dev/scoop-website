{%- render 'section-spacing-collapsing' -%}

{%- assign text_position = section.settings.text_position -%}

<style>
  #shopify-section-{{ section.id }} {
    --section-stack-intro: {% if text_position == 'center' %}66.6667%{% else %}50%{% endif %};
    --section-stack-main: 50%;
  }

  @media screen and (min-width: 1200px) {
    #shopify-section-{{ section.id }} .section-full {
      padding-left: 212px !important;
      padding-right: 212px !important;
    }
    
    #shopify-section-{{ section.id }} .accordion-box{
      padding: 0;
    }
  }

  /* Fit Recommendation Scales */
  .fit-recommendation-scales {
    margin-top: 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .scale-item {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .scale-label {
    font-size: 14px;
    font-weight: 500;
    color: #666;
    text-decoration: underline;
    margin-bottom: 4px;
  }

  .scale-container {
    position: relative;
    width: 100%;
  }

  .scale-line {
    position: relative;
    width: 100%;
    height: 2px;
    background-color: #ddd;
    margin-bottom: 8px;
  }

  .scale-dot {
    position: absolute;
    top: -6px;
    width: 14px;
    height: 14px;
    background-color: #A073B7;
    border-radius: 50%;
    transform: translateX(-50%);
  }

  .scale-labels {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: #666;
  }

  .scale-label-left,
  .scale-label-center,
  .scale-label-right {
    flex: 1;
    text-align: center;
  }

  .scale-label-left {
    text-align: left;
  }

  .scale-label-right {
    text-align: right;
  }
</style>

<div {% render 'section-properties' %}>
  <div class="section-stack {% if text_position != 'center' %}section-stack--horizontal{% else %}section-stack--center{% endif %} {% if text_position == 'end' %}section-stack--reverse{% endif %}">
    {%- capture content -%}
      {%- if section.settings.subheading != blank -%}
        <p class="subheading">{{ section.settings.subheading | escape }}</p>
      {%- endif -%}

      {%- if section.settings.title != blank -%}
        <h2 class="h2">
          {%- render 'styled-text', content: section.settings.title, text_color: section.settings.heading_color, gradient: section.settings.heading_gradient -%}
        </h2>
      {%- endif -%}

      {{- section.settings.content -}}

      {%- if section.settings.button_text != blank -%}
        {% render 'button', content: section.settings.button_text, href: section.settings.button_url, size: 'xl', background: section.settings.button_background, text_color: section.settings.button_text_color %}
      {%- endif -%}
    {%- endcapture -%}

    {%- if content != blank -%}
      <div class="section-stack__intro">
        <div class="prose {% if text_position == 'center' %}text-center{% endif %}">
          {{- content -}}
        </div>
      </div>
    {%- endif -%}

    {%- if section.blocks.size > 0 -%}
      <div class="section-stack__main">
        <div {% render 'surface', class: 'accordion-box rounded', background: section.settings.accordion_background, text_color: section.settings.accordion_text_color, background_fallback: 'bg-secondary' %}>
          {%- for block in section.blocks -%}
            {%- if block.settings.title != blank and block.settings.content != blank -%}
              {%- capture accordion_content -%}
                <div class="prose">
                  {%- comment -%} Filter out metafield values from content {%- endcomment -%}
                  {%- assign content_text = block.settings.page.content | default: block.settings.content -%}
                  {%- if forloop.first and product -%}
                    {%- assign spacing_value = product.metafields.custom.fit_recommendations_spacing -%}
                    {%- assign projection_value = product.metafields.custom.fit_recommendations_projection -%}
                    {%- assign roots_value = product.metafields.custom.fit_recommendations_roots -%}
                    
                    {%- comment -%} Remove metafield values from content text {%- endcomment -%}
                    {%- if spacing_value != blank -%}
                      {%- assign content_text = content_text | remove: spacing_value -%}
                    {%- endif -%}
                    {%- if projection_value != blank -%}
                      {%- assign content_text = content_text | remove: projection_value -%}
                    {%- endif -%}
                    {%- if roots_value != blank -%}
                      {%- assign content_text = content_text | remove: roots_value -%}
                    {%- endif -%}
                  {%- endif -%}
                  
                  {{ content_text }}
                  
                  {%- comment -%} Check if this is the first accordion item and render scale for metafields {%- endcomment -%}
                  {%- if forloop.first and product -%}
                    {%- assign spacing_value = product.metafields.custom.fit_recommendations_spacing -%}
                    {%- assign projection_value = product.metafields.custom.fit_recommendations_projection -%}
                    {%- assign roots_value = product.metafields.custom.fit_recommendations_roots -%}
                    
                    {%- if spacing_value != blank or projection_value != blank or roots_value != blank -%}
                      <div class="fit-recommendation-scales">
                        {%- if spacing_value != blank -%}
                          <div class="scale-item">
                            <div class="scale-label">Spacing</div>
                            <div class="scale-container">
                              <div class="scale-line">
                                <div class="scale-dot" style="left: {{ spacing_value | plus: 5 | times: 10 }}%;"></div>
                              </div>
                              <div class="scale-labels">
                                <span class="scale-label-left">CLOSE-SET</span>
                                <span class="scale-label-center">AVERAGE</span>
                                <span class="scale-label-right">SIDE-SET</span>
                              </div>
                            </div>
                          </div>
                        {%- endif -%}
                        
                        {%- if projection_value != blank -%}
                          <div class="scale-item">
                            <div class="scale-label">Projection</div>
                            <div class="scale-container">
                              <div class="scale-line">
                                <div class="scale-dot" style="left: {{ projection_value | plus: 5 | times: 10 }}%;"></div>
                              </div>
                              <div class="scale-labels">
                                <span class="scale-label-left">SHALLOW</span>
                                <span class="scale-label-center">AVERAGE</span>
                                <span class="scale-label-right">PROJECTED</span>
                              </div>
                            </div>
                          </div>
                        {%- endif -%}
                        
                        {%- if roots_value != blank -%}
                          <div class="scale-item">
                            <div class="scale-label">Roots</div>
                            <div class="scale-container">
                              <div class="scale-line">
                                <div class="scale-dot" style="left: {{ roots_value | plus: 5 | times: 10 }}%;"></div>
                              </div>
                              <div class="scale-labels">
                                <span class="scale-label-left">NARROW</span>
                                <span class="scale-label-center">AVERAGE</span>
                                <span class="scale-label-right">WIDE</span>
                              </div>
                            </div>
                          </div>
                        {%- endif -%}
                      </div>
                    {%- endif -%}
                  {%- endif -%}
                </div>
              {%- endcapture -%}

              {%- assign icon = block.settings.custom_icon | default: block.settings.icon -%}
              {%- render 'accordion', title: block.settings.title, content: accordion_content, icon: icon, icon_width: block.settings.icon_width, block: block -%}
            {%- endif -%}
          {%- endfor -%}
        </div>
      </div>
    {%- endif -%}
  </div>
</div>

{% schema %}
{
  "name": "Accordion content",
  "class": "shopify-section--accordion-content",
  "tag": "section",
  "disabled_on": {
    "templates": ["password"],
    "groups": ["header", "custom.overlay"]
  },
  "blocks": [
    {
      "name": "Item",
      "type": "item",
      "settings": [
        {
          "type": "select",
          "id": "icon",
          "label": "Icon",
          "options": [
            {
              "value": "none",
              "label": "None"
            },
            {
              "value": "picto-coupon",
              "label": "Coupon",
              "group": "Shop"
            },
            {
              "value": "picto-percent",
              "label": "Percent",
              "group": "Shop"
            },
            {
              "value": "picto-gift",
              "label": "Gift",
              "group": "Shop"
            },
            {
              "value": "picto-star",
              "label": "Star",
              "group": "Shop"
            },
            {
              "value": "picto-like",
              "label": "Like",
              "group": "Shop"
            },
            {
              "value": "picto-building",
              "label": "Building",
              "group": "Shop"
            },
            {
              "value": "picto-love",
              "label": "Love",
              "group": "Shop"
            },
            {
              "value": "picto-award-gift",
              "label": "Award gift",
              "group": "Shop"
            },
            {
              "value": "picto-happy",
              "label": "Happy",
              "group": "Shop"
            },
            {
              "value": "picto-box",
              "label": "Box",
              "group": "Shipping"
            },
            {
              "value": "picto-pin",
              "label": "Pin",
              "group": "Shipping"
            },
            {
              "value": "picto-timer",
              "label": "Timer",
              "group": "Shipping"
            },
            {
              "value": "picto-validation",
              "label": "Validation",
              "group": "Shipping"
            },
            {
              "value": "picto-truck",
              "label": "Truck",
              "group": "Shipping"
            },
            {
              "value": "picto-return",
              "label": "Return",
              "group": "Shipping"
            },
            {
              "value": "picto-earth",
              "label": "Earth",
              "group": "Shipping"
            },
            {
              "value": "picto-plane",
              "label": "Plane",
              "group": "Shipping"
            },
            {
              "value": "picto-credit-card",
              "label": "Credit card",
              "group": "Payment & Security"
            },
            {
              "value": "picto-lock",
              "label": "Lock",
              "group": "Payment & Security"
            },
            {
              "value": "picto-shield",
              "label": "Shield",
              "group": "Payment & Security"
            },
            {
              "value": "picto-secure-profile",
              "label": "Secure profile",
              "group": "Payment & Security"
            },
            {
              "value": "picto-money",
              "label": "Money",
              "group": "Payment & Security"
            },
            {
              "value": "picto-recycle",
              "label": "Recycle",
              "group": "Ecology"
            },
            {
              "value": "picto-leaf",
              "label": "Leaf",
              "group": "Ecology"
            },
            {
              "value": "picto-tree",
              "label": "Tree",
              "group": "Ecology"
            },
            {
              "value": "picto-mobile-phone",
              "label": "Mobile phone",
              "group": "Communication"
            },
            {
              "value": "picto-phone",
              "label": "Phone",
              "group": "Communication"
            },
            {
              "value": "picto-chat",
              "label": "Chat",
              "group": "Communication"
            },
            {
              "value": "picto-customer-support",
              "label": "Customer support",
              "group": "Communication"
            },
            {
              "value": "picto-operator",
              "label": "Operator",
              "group": "Communication"
            },
            {
              "value": "picto-mailbox",
              "label": "Mailbox",
              "group": "Communication"
            },
            {
              "value": "picto-envelope",
              "label": "Envelope",
              "group": "Communication"
            },
            {
              "value": "picto-comment",
              "label": "Comment",
              "group": "Communication"
            },
            {
              "value": "picto-question",
              "label": "Question",
              "group": "Communication"
            },
            {
              "value": "picto-send",
              "label": "Send",
              "group": "Communication"
            },
            {
              "value": "picto-at-sign",
              "label": "At sign",
              "group": "Tech"
            },
            {
              "value": "picto-camera",
              "label": "Camera",
              "group": "Tech"
            },
            {
              "value": "picto-wifi",
              "label": "WiFi",
              "group": "Tech"
            },
            {
              "value": "picto-bluetooth",
              "label": "Bluetooth",
              "group": "Tech"
            },
            {
              "value": "picto-printer",
              "label": "Printer",
              "group": "Tech"
            },
            {
              "value": "picto-smart-watch",
              "label": "Smart watch",
              "group": "Tech"
            },
            {
              "value": "picto-coffee",
              "label": "Coffee",
              "group": "Food & Drink"
            },
            {
              "value": "picto-burger",
              "label": "Burger",
              "group": "Food & Drink"
            },
            {
              "value": "picto-beer",
              "label": "Beer",
              "group": "Food & Drink"
            },
            {
              "value": "picto-target",
              "label": "Target",
              "group": "Other"
            },
            {
              "value": "picto-document",
              "label": "Document",
              "group": "Other"
            },
            {
              "value": "picto-jewelry",
              "label": "Jewelry",
              "group": "Other"
            },
            {
              "value": "picto-music",
              "label": "Music",
              "group": "Other"
            },
            {
              "value": "picto-file",
              "label": "File",
              "group": "Other"
            },
            {
              "value": "picto-mask",
              "label": "Mask",
              "group": "Other"
            },
            {
              "value": "picto-stop",
              "label": "Stop",
              "group": "Other"
            }
          ],
          "default": "none"
        },
        {
          "type": "image_picker",
          "id": "custom_icon",
          "label": "Custom icon",
          "info": "96 x 96px .png or .svg recommended"
        },
        {
          "type": "range",
          "id": "icon_width",
          "min": 16,
          "max": 48,
          "step": 2,
          "unit": "px",
          "label": "Icon width",
          "default": 20
        },
        {
          "type": "text",
          "id": "title",
          "label": "Title",
          "default": "Title"
        },
        {
          "type": "richtext",
          "id": "content",
          "label": "Content",
          "default": "<p>Write content to help your customers to better understand your products or policies.</p>"
        },
        {
          "type": "page",
          "id": "page",
          "label": "Page",
          "info": "Replaces inline content if specified."
        }
      ]
    }
  ],
  "settings": [
    {
      "type": "checkbox",
      "id": "full_width",
      "label": "Full width",
      "default": true
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Subheading"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Heading",
      "default": "Heading"
    },
    {
      "type": "richtext",
      "id": "content",
      "label": "Content",
      "default": "<p>Use this text to share information about your brand with your customers. Describe a product, share announcements, or welcome customers to your store.</p>"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button text"
    },
    {
      "type": "url",
      "id": "button_url",
      "label": "Button link"
    },
    {
      "type": "select",
      "id": "text_position",
      "label": "Text position",
      "options": [
        {
          "value": "start",
          "label": "Left"
        },
        {
          "value": "center",
          "label": "Center"
        },
        {
          "value": "end",
          "label": "Right"
        }
      ],
      "default": "start"
    },
    {
      "type": "header",
      "content": "Colors",
      "info": "Gradient replaces solid colors when set."
    },
    {
      "type": "color",
      "id": "background",
      "label": "Background"
    },
    {
      "type": "color_background",
      "id": "background_gradient",
      "label": "Background gradient"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text"
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Heading color"
    },
    {
      "type": "color_background",
      "id": "heading_gradient",
      "label": "Heading gradient"
    },
    {
      "type": "color",
      "id": "button_background",
      "label": "Button background"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Button text"
    },
    {
      "type": "color",
      "id": "accordion_background",
      "label": "Accordion background"
    },
    {
      "type": "color",
      "id": "accordion_text_color",
      "label": "Accordion text"
    }
  ],
  "presets": [
    {
      "name": "Accordion content",
      "category": "Content",
      "blocks": [
        {
          "type": "item",
          "settings": {
            "title": "Question 1"
          }
        },
        {
          "type": "item",
          "settings": {
            "title": "Question 2"
          }
        },
        {
          "type": "item",
          "settings": {
            "title": "Question 3"
          }
        }
      ]
    }
  ]
}
{% endschema %}
