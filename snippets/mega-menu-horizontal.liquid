{%- if link.links.size > 0 or mega_menu_block.settings.layout == 'fittings' or mega_menu_block.settings.layout == 'size_chart' -%}
  <style>
    @media screen and (min-width: 1150px) {
      #mega-menu-{{ mega_menu_block.id }} {
        {%- unless mega_menu_block.settings.layout == 'fittings' or mega_menu_block.settings.layout == 'size_chart' -%}
        --mega-menu-nav-column-max-width: {% if mega_menu_block.settings.submenu_style == 'bold_text' %}{% if link.links.size <= 2 %}240px{% else %}200px{% endif %}{% else %}{% if link.links.size <= 2 %}180px{% else %}160px{% endif %}{% endif %};
        --mega-menu-justify-content: {% if link.links.size == 0 or mega_menu_block.settings.layout == 'horizontal_center' and mega_menu_block.settings.stretch_promo == false %}center{% else %}space-between{% endif %};
        --mega-menu-nav-gap: {% if mega_menu_block.settings.stretch_promo %}var(--spacing-12){% else %}var(--spacing-8){% endif %};

        {% if link.links.size > 3 %}
          --column-list-max-width: 75%;
        {% endif %}
        {%- endunless -%}
      }
    }

    @media screen and (min-width: 1400px) {
      #mega-menu-{{ mega_menu_block.id }} {
        {%- unless mega_menu_block.settings.layout == 'fittings' or mega_menu_block.settings.layout == 'size_chart' -%}
        --mega-menu-nav-column-max-width: {% if mega_menu_block.settings.submenu_style == 'bold_text' %}{% if link.links.size == 1 %}260px{% elsif link.links.size == 2 %}240px{% else %}210px{% endif %}{% else %}{% if link.links.size == 1 %}220px{% elsif link.links.size == 2 %}200px{% else %}180px{% endif %}{% endif %};
        --mega-menu-nav-gap: {% if mega_menu_block.settings.layout == 'horizontal_center' %}var(--spacing-12){% else %}var(--spacing-16){% endif %};

        {% if link.links.size > 4 %}
          --column-list-max-width: 75%;
        {% else %}
          --column-list-max-width: max-content;
        {% endif %}
        {%- endunless -%}
      }
    }

    @media screen and (min-width: 1600px) {
      #mega-menu-{{ mega_menu_block.id }} {
        {%- unless mega_menu_block.settings.layout == 'fittings' or mega_menu_block.settings.layout == 'size_chart' -%}
        --mega-menu-nav-gap: var(--spacing-16);
        {%- endunless -%}
      }
    }

    @media screen and (min-width: 1800px) {
      #mega-menu-{{ mega_menu_block.id }} {
        {%- unless mega_menu_block.settings.layout == 'fittings' or mega_menu_block.settings.layout == 'size_chart' -%}
        --mega-menu-nav-gap: var(--spacing-20);
        {%- endunless -%}
      }
    }
  </style>
{%- endif -%}

<div id="mega-menu-{{ mega_menu_block.id }}" class="mega-menu {% if link.links.size == 0 %}justify-center{% endif %} {% if mega_menu_block.settings.layout == 'fittings' %}mega-menu--fittings{% endif %} {% if mega_menu_block.settings.layout == 'size_chart' %}mega-menu--size-chart{% endif %}">
  {%- if mega_menu_block.settings.layout == 'size_chart' -%}
    {%- comment -%} Size Chart layout: Grid of bra sizes {%- endcomment -%}
    {%- liquid
      assign band_sizes = mega_menu_block.settings.size_chart_band_sizes | split: ','
      assign cup_sizes = mega_menu_block.settings.size_chart_cup_sizes | split: ','
      assign unavailable_sizes_raw = mega_menu_block.settings.size_chart_unavailable_sizes | strip
      assign unavailable_sizes = unavailable_sizes_raw | newline_to_br | split: '<br />'
      assign collection_url_raw = mega_menu_block.settings.size_chart_collection_url | default: '/collections/by-size'
      if collection_url_raw contains 'shopify://'
        assign collection_url = collection_url_raw | replace: 'shopify://collections/', '/collections/'
      else
        assign collection_url = collection_url_raw
      endif
    -%}
    <div class="mega-menu__size-chart">
      <div class="mega-menu__size-chart-grid">
        {%- comment -%} Data rows with size values only {%- endcomment -%}
        {%- for band_size in band_sizes -%}
          {%- assign band_size_trimmed = band_size | strip -%}
          {%- assign is_last_row = forloop.last -%}
          {%- for cup_size in cup_sizes -%}
            {%- assign cup_size_trimmed = cup_size | strip -%}
            {%- assign is_last_column = forloop.last -%}
            {%- assign size_combination = band_size_trimmed | append: cup_size_trimmed -%}
            {%- assign is_unavailable = false -%}
            {%- for unavailable_size in unavailable_sizes -%}
              {%- assign unavailable_size_trimmed = unavailable_size | strip | replace: ' ', '' -%}
              {%- if unavailable_size_trimmed != blank and unavailable_size_trimmed == size_combination -%}
                {%- assign is_unavailable = true -%}
                {%- break -%}
              {%- endif -%}
            {%- endfor -%}
            {%- assign cell_classes = 'mega-menu__size-chart-cell' -%}
            {%- if is_last_column -%}
              {%- assign cell_classes = cell_classes | append: ' mega-menu__size-chart-cell--last-column' -%}
            {%- endif -%}
            {%- if is_last_row -%}
              {%- assign cell_classes = cell_classes | append: ' mega-menu__size-chart-cell--last-row' -%}
            {%- endif -%}
            {%- unless is_unavailable -%}
              {%- assign size_url = collection_url | append: '?filter.v.option.band size=' | append: band_size_trimmed | append: '&filter.v.option.cup size=' | append: cup_size_trimmed -%}
              <div class="{{ cell_classes }} mega-menu__size-chart-cell--available">
                <a href="{{ size_url }}" class="mega-menu__size-chart-link">
                  {{- band_size_trimmed -}} {{- cup_size_trimmed -}}
                </a>
              </div>
            {%- else -%}
              <div class="{{ cell_classes }} mega-menu__size-chart-cell--disabled">
                {{- band_size_trimmed -}} {{- cup_size_trimmed -}}
              </div>
            {%- endunless -%}
          {%- endfor -%}
        {%- endfor -%}
      </div>
    </div>
  {%- elsif mega_menu_block.settings.layout == 'fittings' -%}
    {%- comment -%} Fittings layout: Services list on left, cards on right {%- endcomment -%}
    <div class="mega-menu__fittings-content">
      <div class="mega-menu__fittings-services">
        {%- if mega_menu_block.settings.services_heading != blank -%}
          <h3 class="mega-menu__fittings-heading">{{ mega_menu_block.settings.services_heading }}</h3>
        {%- endif -%}
        {%- if link.links.size > 0 -%}
          <ul class="mega-menu__fittings-list" role="list">
            {%- for sub_link in link.links -%}
              <li>
                <a href="{{ sub_link.url }}" class="mega-menu__fittings-link" {% if sub_link.current %}aria-current="page"{% endif %}>
                  {{- sub_link.title -}}
                </a>
              </li>
            {%- endfor -%}
          </ul>
        {%- endif -%}
      </div>
      
      <div class="mega-menu__fittings-cards">
        {%- for i in (1..3) -%}
          {%- assign image_setting = 'image_' | append: i -%}
          {%- assign heading_setting = 'image_heading_' | append: i -%}
          {%- assign link_setting = 'image_link_' | append: i -%}
          {%- assign text_color_setting = 'image_text_color_' | append: i -%}
          
          {%- if mega_menu_block.settings[image_setting] != blank -%}
            <div class="mega-menu__fittings-card">
              {%- if mega_menu_block.settings[link_setting] != blank -%}
                <a href="{{ mega_menu_block.settings[link_setting] }}" class="mega-menu__fittings-card-link">
              {%- endif -%}
                <div class="mega-menu__fittings-card-image">
                  {{- mega_menu_block.settings[image_setting] | image_url: width: 400 | image_tag: loading: 'lazy', alt: mega_menu_block.settings[heading_setting] -}}
                </div>
                {%- if mega_menu_block.settings[heading_setting] != blank -%}
                  <h4 class="mega-menu__fittings-card-title" style="color: {{ mega_menu_block.settings[text_color_setting] | default: '#ffffff' }};">
                    {{- mega_menu_block.settings[heading_setting] -}}
                  </h4>
                {%- endif -%}
              {%- if mega_menu_block.settings[link_setting] != blank -%}
                </a>
              {%- endif -%}
            </div>
          {%- endif -%}
        {%- endfor -%}
      </div>
    </div>
  {%- else -%}
    {%- comment -%} Standard layout {%- endcomment -%}
    {%- if link.links.size > 0 -%}
      <ul class="mega-menu__nav" role="list">
        {%- for sub_link in link.links -%}
          <li class="v-stack gap-4 justify-items-start">
            <a {% if sub_link.url != '#' %}href="{{ sub_link.url }}"{% endif %} class="{% if mega_menu_block.settings.submenu_style == 'bold_heading' %}h5{% endif %}" {% if sub_link.current %}aria-current="page"{% endif %}>
              <span {% if sub_link.url != '#' %}class="{% if mega_menu_block.settings.submenu_style == 'bold_text' %}link-faded{% else %}reversed-link hover:show{% endif %}"{% endif %}>
                {{- sub_link.title -}}
              </span>
            </a>

            {%- if sub_link.levels > 0 -%}
              <ul class="v-stack gap-2 justify-items-start" role="list">
                {%- for sub_sub_link in sub_link.links -%}
                  <li>
                    <a href="{{ sub_sub_link.url }}" class="{% if mega_menu_block.settings.submenu_style == 'bold_text' %}h5{% else %}link-faded{% endif %}">
                      <span {% if mega_menu_block.settings.submenu_style == 'bold_text' %}class="reversed-link hover:show"{% endif %}>{{- sub_sub_link.title -}}</span>
                    </a>
                  </li>
                {%- endfor -%}
              </ul>
            {%- endif -%}
          </li>
        {%- endfor -%}
      </ul>
    {%- endif -%}

  {%- unless mega_menu_block.settings.layout == 'fittings' -%}
    {% liquid
      # To maximize space, we force a carousel mode depending on the actual content

      assign promo_item_count = 0
      assign use_carousel_fallback_until = ''

      for i in (1..3)
        assign image_setting = 'image_' | append: i

        if mega_menu_block.settings[image_setting] != blank
          assign promo_item_count = promo_item_count | plus: 1
        endif
      endfor

      if mega_menu_block.settings.product != blank
        assign promo_item_count = promo_item_count | plus: 1
      endif

      if link.links.size > 0 and promo_item_count == 4 or mega_menu_block.settings.promo_content_layout == 'carousel'
        assign force_carousel_mode = true
      else
        if link.links.size == 2
          if promo_item_count == 3 and mega_menu_block.settings.layout == 'grid'
            assign use_carousel_fallback_until = 'xl'
          endif
        elsif link.links.size >= 3 and promo_item_count == 3
          if use_promo_collage
            assign use_carousel_fallback_until = 'xl'
          else
            assign use_carousel_fallback_until = '2xl'
          endif
        endif
      endif
    %}

    {%- if force_carousel_mode -%}
      {%- render 'navigation-promo-block', mega_menu_block: mega_menu_block, force_carousel_mode: force_carousel_mode -%}
    {% else %}
      {%- if use_carousel_fallback_until != '' -%}
        {%- render 'navigation-promo-block', navigation_layout: navigation_layout, mega_menu_block: mega_menu_block, link_col: link.links.size, is_navigation_drawer: false, use_carousel_fallback_until: use_carousel_fallback_until -%}
      {%- endif -%}

      {%- render 'navigation-promo-block', navigation_layout: navigation_layout, mega_menu_block: mega_menu_block, link_col: link.links.size, is_navigation_drawer: false, hide_promo_until: use_carousel_fallback_until -%}
    {%- endif -%}
  {%- endunless -%}
  {%- endif -%}
</div>